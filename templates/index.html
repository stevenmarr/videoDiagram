<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Flow Line Diagram Editor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='litegraph.css') }}">
    <script src="{{ url_for('static', filename='litegraph.js') }}"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #mycanvas { width: 100vw; height: 80vh; border: 1px solid #ccc; }
        #controls { padding: 10px; }
        #report { padding: 10px; display: none; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover { color: black; text-decoration: none; cursor: pointer; }
        .dynamic-list { margin-top: 10px; }
        .dynamic-item { margin-bottom: 5px; }
    </style>
</head>
<body>
    <div id="controls">
        <button onclick="openWizard()">Create New Equipment Type</button>
        <button onclick="generateReport()">Generate Report</button>
    </div>
    <canvas id="mycanvas"></canvas>
    <div id="report"></div>

    <!-- Modal for Wizard -->
    <div id="wizardModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeWizard()">&times;</span>
            <h2>Create New Equipment Type</h2>
            <form id="nodeForm">
                <label>Equipment Type Name:</label><br>
                <input type="text" id="nodeName" required><br><br>
                
                <label>Make:</label><br>
                <input type="text" id="make" required><br><br>
                
                <label>Manufacturer:</label><br>
                <input type="text" id="manufacturer" required><br><br>
                
                <label>Specifications:</label><br>
                <textarea id="specs" rows="4" required></textarea><br><br>
                
                <label>Inputs (add ports):</label>
                <div id="inputsList" class="dynamic-list"></div>
                <button type="button" onclick="addDynamicField('inputs')">Add Input</button><br><br>
                
                <label>Outputs (add ports):</label>
                <div id="outputsList" class="dynamic-list"></div>
                <button type="button" onclick="addDynamicField('outputs')">Add Output</button><br><br>
                
                <button type="button" onclick="createNodeType()">Submit</button>
            </form>
        </div>
    </div>

    <script>
        // Setup LiteGraph
        var canvasEl = document.getElementById('mycanvas');
        var dpr = window.devicePixelRatio || 1;
        var cssWidth = window.innerWidth;
        var cssHeight = window.innerHeight * 0.8;
        canvasEl.width = cssWidth * dpr;
        canvasEl.height = cssHeight * dpr;
        canvasEl.style.width = cssWidth + 'px';
        canvasEl.style.height = cssHeight + 'px';

        var graph = new LGraph();
        graph.config = { links_ontop: true };
        var canvas = new LGraphCanvas("#mycanvas", graph);

        // Scale contexts
        canvas.ctx.scale(dpr, dpr);
        canvas.bgctx.scale(dpr, dpr);

        // Set bgcanvas size
        canvas.bgcanvas.width = canvasEl.width;
        canvas.bgcanvas.height = canvasEl.height;

        graph.start();

        // Wizard Functions
        function openWizard() {
            document.getElementById('wizardModal').style.display = 'block';
            // Clear previous fields
            document.getElementById('inputsList').innerHTML = '';
            document.getElementById('outputsList').innerHTML = '';
            document.getElementById('nodeForm').reset();
        }

        function closeWizard() {
            document.getElementById('wizardModal').style.display = 'none';
        }

        function addDynamicField(type) {
            var list = document.getElementById(type + 'List');
            var item = document.createElement('div');
            item.className = 'dynamic-item';
            item.innerHTML = `
                <input type="text" placeholder="Port Name" class="portName" required>
                <input type="text" placeholder="Type (e.g., video or any)" class="portType" required>
            `;
            list.appendChild(item);
        }

        function createNodeType() {
            var name = document.getElementById('nodeName').value;
            var make = document.getElementById('make').value;
            var manufacturer = document.getElementById('manufacturer').value;
            var specs = document.getElementById('specs').value;

            // Collect inputs
            var inputs = [];
            var inputItems = document.querySelectorAll('#inputsList .dynamic-item');
            inputItems.forEach(item => {
                var portName = item.querySelector('.portName').value;
                var portType = item.querySelector('.portType').value;
                if (portName && portType) {
                    if (portType === 'any') portType = -1;
                    inputs.push([portName, portType]);
                }
            });

            // Collect outputs
            var outputs = [];
            var outputItems = document.querySelectorAll('#outputsList .dynamic-item');
            outputItems.forEach(item => {
                var portName = item.querySelector('.portName').value;
                var portType = item.querySelector('.portType').value;
                if (portName && portType) {
                    if (portType === 'any') portType = -1;
                    outputs.push([portName, portType]);
                }
            });

            // Define custom node
            function CustomEquipment() {
                inputs.forEach(([n, t]) => this.addInput(n, t));
                outputs.forEach(([n, t]) => this.addOutput(n, t));
                this.properties = { make, manufacturer, specs };
            }
            CustomEquipment.title = name;
            CustomEquipment.prototype.onDrawBackground = function(ctx) {
                // Optional: Custom rendering, e.g., show specs
            };

            LiteGraph.registerNodeType("equipment/" + name.replace(/\s/g, '_'), CustomEquipment);

            closeWizard();
            alert('New equipment type "' + name + '" created! Search for it in the editor to add instances.');
        }

        // Generate Report
        function generateReport() {
            var data = graph.serialize();
            var reportDiv = document.getElementById('report');
            reportDiv.innerHTML = '';
            reportDiv.style.display = 'block';

            // Inventory Table
            var inventoryHtml = '<h2>Inventory List</h2><table border="1"><tr><th>ID</th><th>Type</th><th>Make</th><th>Manufacturer</th><th>Specifications</th></tr>';
            data.nodes.forEach(node => {
                inventoryHtml += `<tr>
                    <td>${node.id}</td>
                    <td>${node.title}</td>
                    <td>${node.properties.make || 'N/A'}</td>
                    <td>${node.properties.manufacturer || 'N/A'}</td>
                    <td>${node.properties.specs || 'N/A'}</td>
                </tr>`;
            });
            inventoryHtml += '</table>';

            // Connection Tables
            var connectionsHtml = '<h2>Input/Output Connections</h2><table border="1"><tr><th>From Equipment (ID)</th><th>Output Port</th><th>To Equipment (ID)</th><th>Input Port</th></tr>';
            data.links.forEach(link => {
                var [, fromId, fromSlot, toId, toSlot] = link;
                var fromNode = data.nodes.find(n => n.id === fromId);
                var toNode = data.nodes.find(n => n.id === toId);
                var outputName = fromNode.outputs[fromSlot][0];
                var inputName = toNode.inputs[toSlot][0];
                connectionsHtml += `<tr>
                    <td>${fromId} (${fromNode.title})</td>
                    <td>${outputName}</td>
                    <td>${toId} (${toNode.title})</td>
                    <td>${inputName}</td>
                </tr>`;
            });
            connectionsHtml += '</table>';

            reportDiv.innerHTML = inventoryHtml + connectionsHtml;
        }
    </script>
</body>
</html>